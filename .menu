os.pullEvent = os.pullEventRaw 
local w,h = term.getSize()

function getAntID()
    peripheral.find("modem", rednet.open)
    rednet.send(558, "$getAntID")
    antID, antName = rednet.receive(2)
    if antName ~= nil then
    antID, antPosX = rednet.receive(2)
    antID, antPosY = rednet.receive(2)
    antID, antPosZ = rednet.receive(2)
    rednet.close()
    else
    antName = "No signal"
    rednet.close()
    end
end

function getAntPos()
    antennaPos = vector.new(antPosX, antPosY, antPosZ)
    position = vector.new(gps.locate(5))
    displacement = position - antennaPos
    blocksAway = displacement.x + displacement.y + displacement.z
    if blocksAway < 0 then
        blocksAway = math.abs(blocksAway)
    end
end

getAntID()
getAntPos()
  
function printCentered( y,s )
   local x = math.floor((w - string.len(s)) / 2)
   term.setCursorPos(x,y)
   term.clearLine()
   term.write( s )
end
 
local nOption = 1
 
local function drawMenu()
   term.clear()
   term.setCursorPos(w-25,1)
   print(antName)
   term.setCursorPos(w-2,1)
   if blocksAway >= 0 and blocksAway <= 44 then
   print("###")
   elseif blocksAway >= 45 and blocksAway <= 119 then
   print("##-")
   elseif blocksAway >= 120 and blocksAway <= 159 then
   print("#--")
   elseif blocksAway >= 160 then
   print("---")
   end 
end
 
--GUI
term.clear()
local function drawFrontend()
   printCentered( math.floor(h/2) - 3, "")
   printCentered( math.floor(h/2) - 2, "Start Menu" )
   printCentered( math.floor(h/2) - 1, "")
   printCentered( math.floor(h/2) + 0, ((nOption == 1) and "[CMD]") or "CMD " )
   printCentered( math.floor(h/2) + 1, ((nOption == 2) and "[Apps]") or "Apps" )
   printCentered( math.floor(h/2) + 2, ((nOption == 3) and "[Power]") or "Power" )
end
 
drawMenu()
drawFrontend()

while true do
    local event, key = os.pullEvent("key")
    if key == keys.down and nOption < 3 then
        nOption = nOption + 1
        drawMenu()
        drawFrontend()
    --    getAntPos()
    elseif key == keys.up and nOption > 1 then
        nOption = nOption -1
        drawMenu()
        drawFrontend()
    --    getAntPos()
    elseif key == keys.enter then
        if nOption == 1 then
            shell.run("os/.command")
            break
        elseif nOption == 2 then
            shell.run("os/.apps")
            break
        elseif nOption == 3 then
            shell.run("os/.power")
            break
        end    
    end
getAntPos()
end
